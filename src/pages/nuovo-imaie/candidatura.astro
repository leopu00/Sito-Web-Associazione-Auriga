---
import BaseLayout from "../../layouts/BaseLayout.astro";
---
<BaseLayout
  title="Candidatura — L'Arte dell'Attore | Auriga"
  description="Scheda di candidatura online per il laboratorio L'Arte dell'Attore - Io vivo la parola! Corso finanziato da NUOVO IMAIE 2026."
  headerTheme="light"
  headerClass="bg-white"
  headerStyle="background-color:white"
  pageBg="light"
>

  <!-- Hero compatto -->
  <section class="bg-gradient-to-b from-[#003366] to-[#00557a] text-white py-14 md:py-20 px-4">
    <div class="max-w-4xl mx-auto text-center">
      <p class="text-sm uppercase tracking-widest text-blue-200 mb-3">NUOVO IMAIE 2026</p>
      <h1 class="text-3xl md:text-5xl leading-tight mb-3">Scheda di candidatura</h1>
      <p class="text-blue-100">L'Arte dell'Attore — Io vivo la parola!</p>
      <p class="text-sm text-blue-200 mt-4">Scadenza: <strong class="text-white">18 luglio 2026</strong></p>
    </div>
  </section>

  <!-- Form -->
  <section class="max-w-3xl mx-auto px-4 py-12 md:py-16">

    <div id="form-wrapper">

      <p class="text-gray-600 mb-8">
        Compila i campi obbligatori (<span class="text-red-600">*</span>) e allega i documenti richiesti.
        Leggi il <a href="/assets/bando-io-vivo-la-parola.pdf" target="_blank" class="text-[#003366] font-semibold hover:underline">bando completo</a> prima di compilare.
      </p>

      <form id="candidatura-form" novalidate>

        <!-- Dati anagrafici -->
        <fieldset class="mb-10">
          <legend class="text-xl font-bold text-[#003366] mb-6">Dati anagrafici</legend>
          <div class="grid md:grid-cols-2 gap-5">
            <div class="form-field">
              <label for="nome" class="form-label form-label-required">Nome</label>
              <input type="text" id="nome" name="nome" required autocomplete="given-name" class="form-input" placeholder="Il tuo nome" />
            </div>
            <div class="form-field">
              <label for="cognome" class="form-label form-label-required">Cognome</label>
              <input type="text" id="cognome" name="cognome" required autocomplete="family-name" class="form-input" placeholder="Il tuo cognome" />
            </div>
            <div class="form-field">
              <label for="data-nascita" class="form-label form-label-required">Data di nascita</label>
              <input type="date" id="data-nascita" name="data_nascita" required class="form-input" />
            </div>
            <div class="form-field">
              <label for="email" class="form-label form-label-required">Email</label>
              <input type="email" id="email" name="email" required autocomplete="email" class="form-input" placeholder="nome@email.com" />
            </div>
            <div class="form-field">
              <label for="telefono" class="form-label form-label-required">Telefono</label>
              <input type="tel" id="telefono" name="telefono" required autocomplete="tel" class="form-input" placeholder="+39 333 1234567" />
            </div>
            <div class="form-field">
              <label for="citta" class="form-label form-label-required">Domicilio — Città</label>
              <input type="text" id="citta" name="citta" required autocomplete="address-level2" class="form-input" placeholder="Es. Roma" />
            </div>
            <div class="form-field">
              <label for="provincia" class="form-label form-label-required">Provincia</label>
              <input type="text" id="provincia" name="provincia" required maxlength="2" class="form-input uppercase" placeholder="Es. RM" />
            </div>
          </div>
        </fieldset>

        <!-- Requisiti NUOVO IMAIE -->
        <fieldset class="mb-10">
          <legend class="text-xl font-bold text-[#003366] mb-2">Requisiti NUOVO IMAIE</legend>
          <p class="text-sm text-gray-500 mb-6">Riservato ai Soci/Membri iscritti alla data del 10 marzo 2025.</p>
          <div class="grid md:grid-cols-2 gap-5">
            <div class="form-field">
              <label for="codice-imaie" class="form-label form-label-required">Codice ID NUOVO IMAIE</label>
              <input type="text" id="codice-imaie" name="codice_imaie" required class="form-input" placeholder="Il tuo codice identificativo" />
            </div>
            <div class="form-field">
              <label for="data-iscrizione" class="form-label form-label-required">Data di iscrizione</label>
              <input type="date" id="data-iscrizione" name="data_iscrizione_imaie" required class="form-input" />
            </div>
          </div>
        </fieldset>

        <!-- Allegati -->
        <fieldset class="mb-10">
          <legend class="text-xl font-bold text-[#003366] mb-6">Allegati</legend>
          <div class="space-y-6">
            <div class="grid md:grid-cols-2 gap-5">
              <div class="form-field">
                <label for="foto-1" class="form-label form-label-required">Foto 1</label>
                <p class="text-xs text-gray-500">JPG — max 10 MB</p>
                <input type="file" id="foto-1" name="foto_1" required accept=".jpg,.jpeg" class="form-input" />
              </div>
              <div class="form-field">
                <label for="foto-2" class="form-label form-label-required">Foto 2</label>
                <p class="text-xs text-gray-500">JPG — max 10 MB</p>
                <input type="file" id="foto-2" name="foto_2" required accept=".jpg,.jpeg" class="form-input" />
              </div>
            </div>
            <div class="grid md:grid-cols-2 gap-5">
              <div class="form-field">
                <label for="cv" class="form-label form-label-required">Curriculum Vitae</label>
                <p class="text-xs text-gray-500">PDF — max 15 MB</p>
                <input type="file" id="cv" name="cv" required accept=".pdf" class="form-input" />
              </div>
              <div class="form-field">
                <label for="lettera" class="form-label form-label-required">Lettera motivazionale</label>
                <p class="text-xs text-gray-500">PDF — max 15 MB</p>
                <input type="file" id="lettera" name="lettera_motivazionale" required accept=".pdf" class="form-input" />
              </div>
            </div>
          </div>
        </fieldset>

        <!-- Video (facoltativo) -->
        <fieldset class="mb-10">
          <legend class="text-xl font-bold text-[#003366] mb-2">Link video</legend>
          <p class="text-sm text-gray-500 mb-6">Facoltativo — fino a 2 link (YouTube, Vimeo, ecc.).</p>
          <div class="grid md:grid-cols-2 gap-5">
            <div class="form-field">
              <label for="video-1" class="form-label">Video 1</label>
              <input type="url" id="video-1" name="video_1" class="form-input" placeholder="https://..." />
            </div>
            <div class="form-field">
              <label for="video-2" class="form-label">Video 2</label>
              <input type="url" id="video-2" name="video_2" class="form-input" placeholder="https://..." />
            </div>
          </div>
        </fieldset>

        <!-- Privacy -->
        <div class="mb-8 flex items-start gap-3">
          <input type="checkbox" id="privacy" name="privacy" required class="mt-1 h-5 w-5 rounded border-gray-300 text-[#003366] focus:ring-[#003366] cursor-pointer shrink-0" />
          <label for="privacy" class="text-sm text-gray-600 leading-relaxed cursor-pointer">
            Dichiaro di aver letto il <a href="/assets/bando-io-vivo-la-parola.pdf" target="_blank" class="text-[#003366] underline">bando</a>
            e acconsento al trattamento dei dati personali per le finalità connesse alla selezione. <span class="text-red-600">*</span>
          </label>
        </div>

        <!-- Errori -->
        <div id="form-errors" class="hidden bg-red-50 border border-red-200 rounded-xl p-5 mb-8 text-red-800" role="alert" aria-live="assertive">
          <p class="font-semibold mb-2">Correggi i seguenti errori:</p>
          <ul id="error-list" class="list-disc list-inside text-sm space-y-1"></ul>
        </div>

        <!-- Submit -->
        <button type="submit" id="submit-btn" class="form-submit-btn">
          Invia domanda
        </button>

      </form>

      <!-- Contatti -->
      <div class="mt-10 pt-8 border-t border-gray-200 text-center text-sm text-gray-500">
        <p>Informazioni: <strong>Cristina Pedetta</strong> — <a href="tel:+393282634533" class="text-[#003366] hover:underline">328 263 4533</a></p>
        <p class="mt-1"><a href="mailto:info.sprachgestaltung@gmail.com" class="text-[#003366] hover:underline">info.sprachgestaltung@gmail.com</a></p>
        <p class="mt-3"><a href="/io-vivo-la-parola" class="text-[#003366] hover:underline">← Torna alla pagina del progetto</a></p>
      </div>

    </div><!-- /form-wrapper -->

    <!-- Conferma -->
    <div id="success-message" class="hidden">
      <div class="form-success-message py-12">
        <svg class="w-14 h-14 mx-auto mb-4 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <h2 class="text-2xl font-bold text-emerald-800 mb-2">Domanda inviata correttamente</h2>
        <p class="text-emerald-700">Riceverai una mail di conferma.</p>
      </div>
      <div class="text-center mt-8">
        <a href="/io-vivo-la-parola" class="inline-block px-6 py-3 border-2 border-[#003366] text-[#003366] rounded-lg font-semibold hover:bg-[#003366] hover:text-white transition-colors">
          Torna alla pagina del progetto
        </a>
      </div>
    </div>

  </section>

  <script>
    document.addEventListener('astro:page-load', () => {
      const form = document.getElementById('candidatura-form') as HTMLFormElement | null;
      const formWrapper = document.getElementById('form-wrapper');
      const errorsBox = document.getElementById('form-errors');
      const errorList = document.getElementById('error-list');
      const successMessage = document.getElementById('success-message');
      const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement | null;

      if (!form) return;

      const MAX_IMG = 10 * 1024 * 1024;
      const MAX_PDF = 15 * 1024 * 1024;

      function checkFile(input: HTMLInputElement, max: number, exts: string[], label: string): string | null {
        if (!input.files || input.files.length === 0) {
          input.classList.add('form-input-error');
          return `${label}: file mancante.`;
        }
        const f = input.files[0];
        const ext = f.name.split('.').pop()?.toLowerCase() || '';
        if (!exts.includes(ext)) {
          input.classList.add('form-input-error');
          return `${label}: formato non valido (richiesto ${exts.join('/')}).`;
        }
        if (f.size > max) {
          input.classList.add('form-input-error');
          return `${label}: supera ${Math.round(max / (1024 * 1024))} MB.`;
        }
        input.classList.remove('form-input-error');
        return null;
      }

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const errors: string[] = [];
        let firstErr: HTMLElement | null = null;

        // Campi obbligatori
        const fields = [
          { id: 'nome', label: 'Nome' },
          { id: 'cognome', label: 'Cognome' },
          { id: 'data-nascita', label: 'Data di nascita' },
          { id: 'email', label: 'Email' },
          { id: 'telefono', label: 'Telefono' },
          { id: 'citta', label: 'Città' },
          { id: 'provincia', label: 'Provincia' },
          { id: 'codice-imaie', label: 'Codice ID NUOVO IMAIE' },
          { id: 'data-iscrizione', label: 'Data iscrizione NUOVO IMAIE' },
        ];

        fields.forEach(({ id, label }) => {
          const el = document.getElementById(id) as HTMLInputElement | null;
          if (!el || !el.value.trim()) {
            errors.push(`${label} è obbligatorio.`);
            el?.classList.add('form-input-error');
            if (!firstErr && el) firstErr = el;
          } else {
            el.classList.remove('form-input-error');
          }
        });

        // Email formato
        const emailEl = document.getElementById('email') as HTMLInputElement | null;
        if (emailEl && emailEl.value.trim() && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailEl.value)) {
          errors.push('Email: formato non valido.');
          emailEl.classList.add('form-input-error');
          if (!firstErr) firstErr = emailEl;
        }

        // File
        [
          { id: 'foto-1', max: MAX_IMG, exts: ['jpg', 'jpeg'], label: 'Foto 1' },
          { id: 'foto-2', max: MAX_IMG, exts: ['jpg', 'jpeg'], label: 'Foto 2' },
          { id: 'cv', max: MAX_PDF, exts: ['pdf'], label: 'CV' },
          { id: 'lettera', max: MAX_PDF, exts: ['pdf'], label: 'Lettera motivazionale' },
        ].forEach(({ id, max, exts, label }) => {
          const input = document.getElementById(id) as HTMLInputElement;
          const err = checkFile(input, max, exts, label);
          if (err) { errors.push(err); if (!firstErr) firstErr = input; }
        });

        // Privacy
        const priv = document.getElementById('privacy') as HTMLInputElement | null;
        if (!priv?.checked) {
          errors.push('Accetta il consenso al trattamento dati.');
          if (!firstErr && priv) firstErr = priv;
        }

        // Video URL
        ['video-1', 'video-2'].forEach((id, i) => {
          const el = document.getElementById(id) as HTMLInputElement | null;
          if (el && el.value.trim()) {
            try { new URL(el.value.trim()); el.classList.remove('form-input-error'); }
            catch { errors.push(`Video ${i + 1}: URL non valido.`); el.classList.add('form-input-error'); if (!firstErr) firstErr = el; }
          }
        });

        if (errors.length > 0) {
          errorsBox?.classList.remove('hidden');
          if (errorList) errorList.innerHTML = errors.map(e => `<li>${e}</li>`).join('');
          (firstErr || errorsBox)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
          return;
        }

        errorsBox?.classList.add('hidden');
        if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Invio in corso...'; }

        setTimeout(() => {
          formWrapper?.classList.add('hidden');
          successMessage?.classList.remove('hidden');
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }, 1200);
      });
    });
  </script>
</BaseLayout>
